import * as p from "@clack/prompts";
import chalk from "chalk";
import { api, getFrontendBaseUrl } from "../api.js";
export function formatElapsed(ms) {
    const totalSeconds = Math.floor(ms / 1000);
    const minutes = Math.floor(totalSeconds / 60);
    const seconds = totalSeconds % 60;
    return minutes > 0 ? `${minutes}m ${seconds}s` : `${seconds}s`;
}
export async function deployAndWait({ initial, startedAt, teamId, projectId, }) {
    const spinner = p.spinner();
    spinner.start("Deployment in progress");
    const deploymentPageUrl = `${getFrontendBaseUrl()}/team/${teamId}/project/${projectId}/deployments/${initial.id}`;
    p.note(deploymentPageUrl, "View deployment details:");
    const elapsedInterval = setInterval(() => {
        const elapsed = formatElapsed(Date.now() - startedAt);
        spinner.message(`Deployment in progress â€” ${elapsed}`);
    }, 1000);
    const timeoutMs = 15 * 60 * 1000; // 15 minutes
    let deployment = initial;
    try {
        while (deployment.status === "ongoing") {
            const elapsedMs = Date.now() - startedAt;
            if (elapsedMs >= timeoutMs) {
                throw new Error(`Deployment aborted after 15 minutes. View status: ${deploymentPageUrl}`);
            }
            await new Promise((resolve) => setTimeout(resolve, 10_000));
            deployment = await api.getDeployment(deployment.id);
        }
        return { deployment, elapsedMs: Date.now() - startedAt };
    }
    finally {
        const message = deployment.status === "deployed" ? chalk.green("Deployment completed") : chalk.red("Deployment failed");
        spinner.stop(message);
        clearInterval(elapsedInterval);
    }
}
//# sourceMappingURL=deployment.js.map