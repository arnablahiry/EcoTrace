import nodemonOriginal, {} from "nodemon";
import { useEffect, useState } from "react";
const nodemon = nodemonOriginal;
export function useNodemon(env) {
    const [messages, setMessages] = useState([]);
    useEffect(() => {
        nodemon({
            env,
            configFile: "nodemon.json",
            stdout: false,
        });
        const handleStdoutData = (chunk) => {
            const message = chunk.toString().trim();
            if (message) {
                setMessages((prev) => [...prev, { text: message, type: "log" }]);
            }
        };
        const handleStderrData = (chunk) => {
            const message = chunk.toString().trim();
            if (message) {
                setMessages((prev) => [...prev, { text: message, type: "error" }]);
            }
        };
        const setupStdoutListener = () => {
            if (nodemon.stdout) {
                nodemon.stdout.off("data", handleStdoutData);
                nodemon.stdout.on("data", handleStdoutData);
            }
        };
        const setupStderrListener = () => {
            if (nodemon.stderr) {
                nodemon.stderr.off("data", handleStderrData);
                nodemon.stderr.on("data", handleStderrData);
            }
        };
        nodemon.on("readable", () => {
            setupStdoutListener();
            setupStderrListener();
        });
        nodemon.on("restart", (files) => {
            const restartMessage = `Server restarted due to file changes: ${files.join(", ")}`;
            setMessages((prev) => [
                ...prev,
                { text: restartMessage, type: "restart" },
            ]);
            setupStdoutListener();
            setupStderrListener();
        });
        return () => {
            if (nodemon.stdout) {
                nodemon.stdout.off("data", handleStdoutData);
            }
            if (nodemon.stderr) {
                nodemon.stderr.off("data", handleStderrData);
            }
            nodemon.emit("quit");
        };
    }, [env]);
    return messages;
}
//# sourceMappingURL=use-nodemon.js.map